name: Check COAT dev deployment

on:
  pull_request:

name: Verify Dev Deployment

jobs:
  verify-dev-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest dev deployment run for this branch
        uses: actions/github-script@v7
        with:
          script: |
            const workflowId = ".github/workflows/cicd-mega-linter.yml"
            const branch = context.payload.pull_request.head.ref

            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowId,
              branch,
              per_page: 1
            })

            if (!runs.data.workflow_runs.length) {
              core.setFailed(`No dev deployment workflow runs found for branch: ${branch}`)
              return
            }

            const latestRun = runs.data.workflow_runs[0]

            if (latestRun.conclusion !== "success") {
              core.setFailed(
                `Latest dev deployment on branch "${branch}" did not succeed. ` +
                `Status: ${latestRun.conclusion}. Run: ${latestRun.html_url}`
              )
            } else {
              core.info(`Dev deploy verified successful for branch "${branch}".`)
            }
